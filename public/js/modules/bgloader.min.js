var __awaiter=this&&this.__awaiter||function(i,t,e,s){return new(e||(e=Promise))((function(n,r){function h(i){try{a(s.next(i))}catch(i){r(i)}}function o(i){try{a(s.throw(i))}catch(i){r(i)}}function a(i){var t;i.done?n(i.value):(t=i.value,t instanceof e?t:new e((function(i){i(t)}))).then(h,o)}a((s=s.apply(i,t||[])).next())}))};import{roundFloat,defined,shuffleArray,sizeTemplate}from"./functions.min.js";import Timer from"./timer.min.js";export default class BgLoader{constructor(i,t,e,s,n,r,h,o){this.slideTransitionLength=300,this.slideDefaultTransition=`transform ${this.slideTransitionLength} ease-in-out`,this.direction=0,this.options={stretch:1,sizeLimit:0,failLimit:5},this.slider=i,this.slides=t,this.touchAreaLeft=h,this.touchAreaRight=o,this.images=shuffleArray(e),this.sizes=s,this.baseUrl=n,this.imgPrefix=r,this.currentIndex=0,this.failedLoading=[],this.preloaded=[],this.busy=!1,this.options.sizeLimit=s.length,this.timer=new Timer}setSliderX(i){this.slider.style.transform=`translateX(${i}px)`}setSliderTransition(i){this.slider.style.transition="number"==typeof i?`transform ${i}ms ease-in-out`:"none"}updateLoadingOptions(){const i=this.timer.avg();let t=this.options;1e3<i?(t.sizeLimit=1,t.stretch=.8):800<i?(t.sizeLimit=2,t.stretch=.6):600<i?(t.sizeLimit=3,t.stretch=.4):300<i?(t.sizeLimit=4,t.stretch=.2):(t.sizeLimit=5,t.stretch=0),t.sizeLimit>this.sizes.length&&(t.sizeLimit=this.sizes.length),this.options=t}getScreenSize(){const i=sizeTemplate();return i.w=window.screen.width,i.h=window.screen.height,i.min=Math.min(i.w,i.h),i.max=Math.max(i.w,i.h),i.ls=i.w>=i.h,i.ratio=roundFloat(i.max/i.min,2),i}getImgSize(i,t){const e=sizeTemplate();return e.max=t.value,e.min=Math.floor(t.value/i.ratio),e.ls=i.ls,e.ratio=i.ratio,i.ls?(e.w=e.max,e.h=e.min):(e.w=e.min,e.h=e.max),e}getImgName(i,t){i<0&&(i=this.images.length-1),i>this.images.length-1&&(i=0);const e=this.images[i],s=this.getScreenSize();let n=defined(this.sizes[t])?this.sizes[t]:void 0,r=defined(n)?this.getImgSize(e,n):void 0;if(!defined(n)||!defined(r))for(let i=0;i<this.options.sizeLimit;i++)if(n=this.sizes[i],!(i<this.options.sizeLimit-1&&s.max>n.value)){if(!defined(e.ratio)||!defined(e.ls))break;if(r=this.getImgSize(e,n),!(i<this.options.sizeLimit-1&&e.ls!==s.ls&&r.min<s.max&&r.min/s.max<1-this.options.stretch||i<this.options.sizeLimit&&e.ls===s.ls&&r.min<s.min&&r.min/s.min<1-this.options.stretch))break}return defined(n.key)||(n=this.sizes[0]),this.imgPrefix+e.name+n.key+".jpg"}getImgUrl(i,t){const e=this.getImgName(i,t);if("string"==typeof e&&0!==e.length)return this.baseUrl+"/"+e}incCurrent(i){if(this.images.length>0){let t=i<0?this.currentIndex-1:this.currentIndex+1;t<0&&(t=this.images.length-1),t>this.images.length-1&&(t=0),this.currentIndex=t}}unsetImg(i){return __awaiter(this,void 0,void 0,(function*(){this.failedLoading.push(this.images.splice(i,1)[0]),this.failedLoading.length>=this.options.failLimit&&(console.error("Failed loading images from API, aborting execution..."),this.images=[])}))}preloadImgUrl(i){return __awaiter(this,void 0,void 0,(function*(){let t=this;return new Promise(((e,s)=>{defined(i)&&"string"==typeof i||e(!1);const n=t.preloaded.indexOf(i);n>=0&&e(!0),t.timer.start();const r=new Image;r.onload=()=>{t.preloaded.unshift(i)>25&&t.preloaded.pop(),t.updateLoadingOptions(),t.timer.stop(),e(!0)},r.onerror=()=>{r.onerror=null,n>=0&&t.preloaded.splice(n,1),t.timer.reset(),e(!1)},r.src=i}))}))}preload(i=0){return __awaiter(this,void 0,void 0,(function*(){const t=i<0?this.currentIndex-1:this.currentIndex+1,e=this.getImgUrl(t);e.length>this.baseUrl.length&&(yield this.preloadImgUrl(e))}))}testLoadingSpeed(){return __awaiter(this,void 0,void 0,(function*(){if(0===this.images.length||0===this.sizes.length)return;const i=this.getImgUrl(this.currentIndex,0);yield this.preloadImgUrl(i)}))}loadSlideBackground(i,t){return __awaiter(this,void 0,void 0,(function*(){if(this.images.length<=0)return;let e=this.currentIndex+t;for(;e<0||e>this.images.length-1;)e<0?e+=this.images.length:e>this.images.length-1&&(e-=this.images.length);const s=this.getImgUrl(e),n=`url(${s})`;if(i.style.backgroundImage!==n){this.busy=!0;!0===(yield this.preloadImgUrl(s))?i.style.backgroundImage=n:(this.unsetImg(e),yield this.loadSlideBackground(i,t))}this.busy=!1}))}onTransitionEnd(){if(0!==this.direction){let i,t,e=this.slider.firstElementChild,s=this.slider.lastElementChild;this.direction<0?(this.currentIndex++,this.slider.appendChild(e),t=2,i=e):(this.currentIndex--,this.slider.insertBefore(s,e),t=-2,i=s),this.currentIndex>this.images.length-1?this.currentIndex=0:this.currentIndex<0&&(this.currentIndex=this.images.length-1),this.setSliderTransition(!1),this.setSliderX(0),setTimeout((()=>{this.loadSlideBackground(i,t),this.direction=0,this.setSliderTransition(this.slideTransitionLength)}))}}move(i=0){if(Date.now()-this.keyDownTimeout>this.slideTransitionLength){this.direction=i<0?-1:1;let t=i<0?this.touchAreaRight:this.touchAreaLeft;t.classList.add("show"),this.setSliderX(this.direction*window.innerWidth),setTimeout((()=>t.classList.remove("show")),this.slideTransitionLength),this.keyDownTimeout=Date.now()}}moveLeft(){this.move(-1)}moveRight(){this.move(1)}initBackgrounds(){return __awaiter(this,void 0,void 0,(function*(){let i=-Math.floor(this.slides.length/2);for(let t=0;t<this.slides.length;t++)yield this.loadSlideBackground(this.slides[t],i+t),this.slides[t].style.opacity="1"}))}init(){return __awaiter(this,void 0,void 0,(function*(){this.images.length>=this.slides.length&&(this.keyDownTimeout=Date.now(),yield this.testLoadingSpeed(),yield this.initBackgrounds(),this.setSliderTransition(this.slideTransitionLength),this.slider.ontransitionend=()=>{this.onTransitionEnd()})}))}}
